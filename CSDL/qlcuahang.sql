IF EXISTS (SELECT * 
	   FROM   master..sysdatabases 
	   WHERE  name = N'QLCHmoi')
	DROP DATABASE QLCHmoi
GO

CREATE DATABASE QLCHmoi
GO
USE QLCHmoi
GO
------------------------------------
---------T?o các b?ng---------------
------------------------------------

-----------------------------------
----------KHÁCH HÀNG-------------
------------------------------------
IF EXISTS (SELECT * 
	   FROM   master..sysdatabases 
	   WHERE  name = N'KHACHHANG')
	DROP DATABASE KHACHHANG
GO
CREATE TABLE KHACHHANG
(
	MAKH VARCHAR(6)NOT NULL,
	HOTEN NVARCHAR(30) NULL,
	DIACHI NVARCHAR(50)NULL,
	DIENTHOAI VARCHAR(11)NULL
)
GO

-------------------------------------
-----------L?AI NHÂN VIÊN------------
-------------------------------------
IF EXISTS (SELECT * 
	   FROM   master..sysdatabases 
	   WHERE  name = N'LOAINHANVIEN')
	DROP DATABASE LOAINHANVIEN
GO

CREATE TABLE LOAINHANVIEN
(
	MALOAINV VARCHAR(6) NOT NULL,
	TENLOAINV NVARCHAR(20) NULL
)
GO

-------------------------------------
------------GI?I TÍNH-----------------
--------------------------------------
IF EXISTS (SELECT * 
	   FROM   master..sysdatabases 
	   WHERE  name = N'GIOITINH')
	DROP DATABASE GIOITINH
GO 
CREATE TABLE GIOITINH
(
	GIOITINH VARCHAR(6)NOT NULL,
	TENGIOITINH NVARCHAR(10) NULL
)
GO

------------------------------------
-----------NHÂN VIÊN----------------
------------------------------------
IF EXISTS (SELECT * 
	   FROM   master..sysdatabases 
	   WHERE  name = N'NHANVIEN')
	DROP DATABASE NHANVIEN
GO
CREATE TABLE NHANVIEN
(
	MANV VARCHAR(6) NOT NULL,
	HOTEN NVARCHAR(30) NULL,
	DIACHI NVARCHAR(50) NULL,
	NGAYSINH DATETIME NULL,
	GIOITINH VARCHAR(6) NULL,
	DIENTHOAI VARCHAR(11)NULL,
	USERNAME VARCHAR(50)NULL,
	PASSWORDS VARCHAR(50)NULL,
	MALOAINV VARCHAR(6) NULL
)
GO

--------------------------------------
-----------NHÀ CUNG C?P---------------
--------------------------------------
IF EXISTS (SELECT * 
	   FROM   master..sysdatabases 
	   WHERE  name = N'NHACUNGCAP')
	DROP DATABASE NHACUNGCAP
GO
CREATE TABLE NHACUNGCAP
(
	MANCC VARCHAR(8) NOT NULL,
	TENNCC NVARCHAR(30) NULL,
	DIACHI NVARCHAR(40) NULL,
	DIENTHOAI VARCHAR(11)NULL
)
GO

--------------------------------------
------------ÐON V? TÍNH---------------
--------------------------------------
IF EXISTS (SELECT * 
	   FROM   master..sysdatabases 
	   WHERE  name = N'DONVITINH')
	DROP DATABASE DONVITINH
GO
CREATE TABLE DONVITINH
(
	MADVT VARCHAR(6) NOT NULL,
	TENDVT NVARCHAR(30) NULL
)
GO

--------------------------------------
------------HÀNG HÓA----------------
------------------------------------
IF EXISTS (SELECT * 
	   FROM   master..sysdatabases 
	   WHERE  name = N'HANGHOA')
	DROP DATABASE HANGHOA
GO
CREATE TABLE HANGHOA
(
	MAHH VARCHAR(8) NOT NULL,
	TENHH NVARCHAR(30) NULL,
	MADVT VARCHAR(6)NULL,	
	NGAYHETHAN DATETIME NULL,
	SOLUONG INT NULL,
	SOLUONGGIAM INT NULL,
	TILEGIAM INT NULL,
	DONGIA INT NULL
)
GO

-------------------------------------
------------PHI?U BÁN HÀNG-----------
-------------------------------------
IF EXISTS (SELECT * 
	   FROM   master..sysdatabases 
	   WHERE  name = N'PHIEUBANHANG')
	DROP DATABASE PHIEUBANHANG
GO
CREATE TABLE PHIEUBANHANG
(
	MAPHIEU VARCHAR(6) NOT NULL,
	MAKH VARCHAR(6) NULL,
	MANV VARCHAR(6)NOT NULL,	
	NGAYLAP DATETIME NULL,
	TONGTIEN INT NULL
	
)
GO

-----------------------------------
----------PHI?U Ð?T HÀNG-----------
-----------------------------------
IF EXISTS (SELECT * 
	   FROM   master..sysdatabases 
	   WHERE  name = N'PHIEUDATHANG')
	DROP DATABASE PHIEUDATHANG
GO
CREATE TABLE PHIEUDATHANG
(
	MAPHIEUDATHANG VARCHAR(6) NOT NULL,
	MANCC VARCHAR(8)NOT NULL,
	MANV VARCHAR(6) NOT NULL,
	NGAYLAP DATETIME NULL,
	
)
GO

----------------------------------------
-----------PHI?U NH?N HÀNG--------------
-----------------------------------------
IF EXISTS (SELECT * 
	   FROM   master..sysdatabases 
	   WHERE  name = N'PHIEUNHANHANG')
	DROP DATABASE PHIEUNHANHANG
GO
CREATE TABLE PHIEUNHANHANG
(
	MAPHIEU VARCHAR(6) NOT NULL,
	MANCC VARCHAR(8)NOT NULL,
	MANV VARCHAR(6)NOT NULL,	
	NGAYLAP DATETIME NULL,
	TONGTIEN INT NULL
	
)
GO

--------------------------------------------
------------CHI TI?T PHI?U BÁN HÀNG----------
--------------------------------------------
IF EXISTS (SELECT * 
	   FROM   master..sysdatabases 
	   WHERE  name = N'CHITIETPHIEUBANHANG')
	DROP DATABASE CHITIETPHIEUBANHANG
GO
CREATE TABLE CHITIETPHIEUBANHANG
(
	MAPHIEU VARCHAR(6) NOT NULL,
	MAHH VARCHAR(8)NOT NULL,
	DONGIA INT NULL,
	SOLUONG INT NULL,
	THANHTIEN INT NULL
)
GO

-----------------------------------------------
------------CHI TI?T PHI?U Ð?T HÀNG-----------
----------------------------------------------
IF EXISTS (SELECT * 
	   FROM   master..sysdatabases 
	   WHERE  name = N'CHITIETPHIEUDATHANG')
	DROP DATABASE CHITIETPHIEUDATHANG
GO
CREATE TABLE CHITIETPHIEUDATHANG
(
	MAPHIEUDATHANG VARCHAR(6) NOT NULL,
	MAHH VARCHAR(8)NOT NULL,
	SOLUONG INT NULL
)
GO

---------------------------------------------
----------CHI TI?T PHI?U NH?N HÀNG------------
---------------------------------------------
IF EXISTS (SELECT * 
	   FROM   master..sysdatabases 
	   WHERE  name = N'CHITIETPHIEUNHANHANG')
	DROP DATABASE CHITIETPHIEUNHANHANG
GO
CREATE TABLE CHITIETPHIEUNHANHANG
(
	MAPHIEU VARCHAR(6) NOT NULL,
	MAHH VARCHAR(8) NOT NULL,
	DONGIA INT NULL,
	SOLUONG INT NULL,
	THANHTIEN INT NULL,
	MAPHIEUDATHANG VARCHAR(6)NOT NULL  
)
GO

-----------------------------------------------
----------------PHI?U S? C?--------------------
------------------------------------------------
IF EXISTS (SELECT * 
	   FROM   master..sysdatabases 
	   WHERE  name = N'PHIEUSUCO')
	DROP DATABASE PHIEUSUCO
GO
CREATE TABLE PHIEUSUCO
(
	MAPHIEUSUCO VARCHAR(6) NOT NULL,
	MAHH VARCHAR(8) NOT NULL,
	NGAYHUHONG DATETIME NULL,
	LYDO VARCHAR(1000) NULL,
	SOLUONGHUHONG INT NULL,
	DONGIA INT NULL,
	TONGTIENHUHONG INT NULL
)
GO

-----------------------------------------------
-----------------T?N KHO-------------------
-----------------------------------------------
IF EXISTS (SELECT * 
	   FROM   master..sysdatabases 
	   WHERE  name = N'TONKHO')
	DROP DATABASE TONKHO
GO
CREATE TABLE TONKHO
(
	THOIGIAN DATETIME NOT NULL,
	MAHH VARCHAR(8)NOT NULL,
	SLTON INT NULL
)
GO

------------------------------------------
--==========T?O KHÓA CHÍNH==============
------------------------------------------
ALTER TABLE KHACHHANG
ADD CONSTRAINT P_MAKH PRIMARY KEY(MAKH)

ALTER TABLE LOAINHANVIEN
ADD CONSTRAINT P_MALOAINV PRIMARY KEY(MALOAINV)

ALTER TABLE GIOITINH
ADD CONSTRAINT P_GIOITINH PRIMARY KEY(GIOITINH)

ALTER TABLE NHANVIEN
ADD CONSTRAINT P_MANV PRIMARY KEY(MANV)

ALTER TABLE NHACUNGCAP
ADD CONSTRAINT P_MANCC PRIMARY KEY(MANCC)

ALTER TABLE DONVITINH
ADD CONSTRAINT P_MADVT PRIMARY KEY(MADVT)

ALTER TABLE HANGHOA
ADD CONSTRAINT P_MAHH PRIMARY KEY(MAHH)

ALTER TABLE PHIEUBANHANG
ADD CONSTRAINT P_MAPHIEU PRIMARY KEY(MAPHIEU)

ALTER TABLE PHIEUDATHANG
ADD CONSTRAINT P_MAPHIEUDATHANG PRIMARY KEY(MAPHIEUDATHANG)

ALTER TABLE PHIEUNHANHANG
ADD CONSTRAINT PN_MAPHIEU PRIMARY KEY(MAPHIEU)

ALTER TABLE CHITIETPHIEUBANHANG
ADD CONSTRAINT P_CT_PBH PRIMARY KEY(MAPHIEU,MAHH)

ALTER TABLE CHITIETPHIEUDATHANG
ADD CONSTRAINT P_CT_PDH PRIMARY KEY(MAPHIEUDATHANG,MAHH)

ALTER TABLE CHITIETPHIEUNHANHANG
ADD CONSTRAINT P_CT_PNH PRIMARY KEY(MAPHIEU,MAHH)

ALTER TABLE PHIEUSUCO
ADD CONSTRAINT P_MAPHIEUSUCO PRIMARY KEY(MAPHIEUSUCO)

ALTER TABLE TONKHO
ADD CONSTRAINT P_TONKHO PRIMARY KEY(THOIGIAN)

----------------------------------------------
--=============T?O KHÓA NGO?I================
----------------------------------------------
ALTER TABLE NHANVIEN 
ADD CONSTRAINT F_NV_GIOITINH FOREIGN KEY(GIOITINH) REFERENCES GIOITINH(GIOITINH)

ALTER TABLE NHANVIEN 
ADD CONSTRAINT F_NV_LOAINHANVIEN FOREIGN KEY(MALOAINV) REFERENCES LOAINHANVIEN(MALOAINV)

ALTER TABLE HANGHOA 
ADD CONSTRAINT F_HANGHOA_DONVITINH FOREIGN KEY(MADVT) REFERENCES DONVITINH(MADVT)

ALTER TABLE PHIEUBANHANG 
ADD CONSTRAINT F_PHIEUBANHANG_KHACHHANG FOREIGN KEY(MAKH) REFERENCES KHACHHANG(MAKH)

ALTER TABLE PHIEUBANHANG 
ADD CONSTRAINT F_PBH_NHANVIEN FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)

ALTER TABLE PHIEUDATHANG 
ADD CONSTRAINT F_PDH_NHACUNGCAP FOREIGN KEY(MANCC) REFERENCES NHACUNGCAP(MANCC)

ALTER TABLE PHIEUDATHANG 
ADD CONSTRAINT F_PDH_NHANVIEN FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)

ALTER TABLE CHITIETPHIEUBANHANG 
ADD CONSTRAINT FF_CTPBH_PBH FOREIGN KEY(MAPHIEU) REFERENCES PHIEUBANHANG(MAPHIEU)

ALTER TABLE CHITIETPHIEUBANHANG 
ADD CONSTRAINT F_CTPBH_HH FOREIGN KEY(MAHH) REFERENCES HANGHOA(MAHH)

ALTER TABLE CHITIETPHIEUDATHANG 
ADD CONSTRAINT F_CTPDH_PDH FOREIGN KEY(MAPHIEUDATHANG) REFERENCES PHIEUDATHANG(MAPHIEUDATHANG)

ALTER TABLE CHITIETPHIEUDATHANG 
ADD CONSTRAINT F_CTPDH_HH FOREIGN KEY(MAHH) REFERENCES HANGHOA(MAHH)

ALTER TABLE CHITIETPHIEUNHANHANG 
ADD CONSTRAINT F_CTPNH_PNH FOREIGN KEY(MAPHIEU) REFERENCES PHIEUNHANHANG(MAPHIEU)

ALTER TABLE CHITIETPHIEUNHANHANG 
ADD CONSTRAINT F_CTPNH_HH FOREIGN KEY(MAHH) REFERENCES HANGHOA(MAHH)

ALTER TABLE PHIEUSUCO 
ADD CONSTRAINT F_PSC_HH FOREIGN KEY(MAHH) REFERENCES HANGHOA(MAHH)

ALTER TABLE TONKHO 
ADD CONSTRAINT F_TONKHO_HH FOREIGN KEY(MAHH) REFERENCES HANGHOA(MAHH)

------------------------------------------------------------------
----===========FUNCTION========================-------------------
------------------------------------------------------------------

------------------Khach Hang---------------------
IF EXISTS(SELECT name FROM sys.objects WHERE name = N'AUTO_IDKhachHang')
DROP FUNCTION dbo.AUTO_IDKhachHang;
GO
	CREATE FUNCTION dbo.AUTO_IDKhachHang()
	RETURNS VARCHAR(8)
	AS
	BEGIN
		DECLARE @ID VARCHAR(8)
		IF (SELECT COUNT(MAKH) FROM KHACHHANG) = 0
			SET @ID = '001'
		ELSE
		BEGIN
			SELECT @ID = MAX(RIGHT(MAKH, LEN(MAKH) - 2)) FROM KHACHHANG;
			SET @ID = @ID + 1
			WHILE LEN(@ID) < 3 
			BEGIN 
				SET @ID = '0' + @ID 
			END
		END
		SET @ID = 'KH' + @ID

		RETURN @ID
	END
GO

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'Insert_New_Customer')
DROP PROCEDURE dbo.Insert_New_Customer;
GO
	CREATE PROCEDURE dbo.Insert_New_Customer
	AS
	BEGIN
		DECLARE @ID VARCHAR(8)
		SELECT @ID = dbo.AUTO_IDKhachHang() 
		INSERT INTO KHACHHANG
		VALUES(@ID,'','','')
	END
GO


------------------Nha cung cap---------------------
IF EXISTS(SELECT name FROM sys.objects WHERE name = N'AUTO_IDNhaCungCap')
DROP FUNCTION dbo.AUTO_IDNhaCungCap;
GO
	CREATE FUNCTION dbo.AUTO_IDNhaCungCap()
	RETURNS VARCHAR(8)
	AS
	BEGIN
		DECLARE @ID VARCHAR(8)
		IF (SELECT COUNT(MANCC) FROM NHACUNGCAP) = 0
			SET @ID = '001'
		ELSE
		BEGIN
			SELECT @ID = MAX(RIGHT(MANCC, LEN(MANCC) - 3)) FROM NHACUNGCAP;
			SET @ID = @ID + 1
			WHILE LEN(@ID) < 3 
			BEGIN 
				SET @ID = '0' + @ID 
			END
		END
		SET @ID = 'NCC' + @ID

		RETURN @ID
	END
GO

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'Insert_New_Supplier')
DROP PROCEDURE dbo.Insert_New_Supplier;
GO
	CREATE PROCEDURE dbo.Insert_New_Supplier
	AS
	BEGIN
		DECLARE @ID VARCHAR(8)
		SELECT @ID = dbo.AUTO_IDNhaCungCap() 
		INSERT INTO NHACUNGCAP
		VALUES(@ID,'','','')
	END
GO

------------------Don Vi Tinh---------------------
IF EXISTS(SELECT name FROM sys.objects WHERE name = N'AUTO_IDDonViTinh')
DROP FUNCTION dbo.AUTO_IDDonViTinh;
GO
	CREATE FUNCTION dbo.AUTO_IDDonViTinh()
	RETURNS VARCHAR(6)
	AS
	BEGIN
		DECLARE @ID VARCHAR(6)
		IF (SELECT COUNT(MADVT) FROM DONVITINH) = 0
			SET @ID = '001'
		ELSE
		BEGIN
			SELECT @ID = MAX(RIGHT(MADVT, LEN(MADVT) - 3)) FROM DONVITINH;
			SET @ID = @ID + 1
			WHILE LEN(@ID) < 3 
			BEGIN 
				SET @ID = '0' + @ID 
			END
		END
		SET @ID = 'DVT' + @ID

		RETURN @ID
	END
GO

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'Insert_New_Unit')
DROP PROCEDURE dbo.Insert_New_Unit;
GO
	CREATE PROCEDURE dbo.Insert_New_Unit
	AS
	BEGIN
		DECLARE @ID VARCHAR(6)
		SELECT @ID = dbo.AUTO_IDDonViTinh() 
		INSERT INTO DONVITINH
		VALUES(@ID,'')
	END
GO

------------------Hang Hoa---------------------
IF EXISTS(SELECT name FROM sys.objects WHERE name = N'AUTO_IDHangHoa')
DROP FUNCTION dbo.AUTO_IDHangHoa;
GO
	CREATE FUNCTION dbo.AUTO_IDHangHoa()
	RETURNS VARCHAR(8)
	AS
	BEGIN
		DECLARE @ID VARCHAR(8)
		IF (SELECT COUNT(MAHH) FROM HANGHOA) = 0
			SET @ID = '001'
		ELSE
		BEGIN
			SELECT @ID = MAX(RIGHT(MAHH, LEN(MAHH) - 2)) FROM HANGHOA;
			SET @ID = @ID + 1
			WHILE LEN(@ID) < 3 
			BEGIN 
				SET @ID = '0' + @ID 
			END
		END
		SET @ID = 'HH' + @ID

		RETURN @ID
	END
GO

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'Insert_New_Goods')
DROP PROCEDURE dbo.Insert_New_Goods;
GO
	CREATE PROCEDURE dbo.Insert_New_Goods
	AS
	BEGIN
		DECLARE @ID VARCHAR(8)
		SELECT @ID = dbo.AUTO_IDHangHoa() 
		INSERT INTO HANGHOA
		VALUES(@ID,'','DVT001','1/1/2017','0','0','0','')
	END
GO

------------------Nhan Vien---------------------
IF EXISTS(SELECT name FROM sys.objects WHERE name = N'AUTO_IDNhanVien')
DROP FUNCTION dbo.AUTO_IDNhanVien;
GO
	CREATE FUNCTION dbo.AUTO_IDNhanVien()
	RETURNS VARCHAR(6)
	AS
	BEGIN
		DECLARE @ID VARCHAR(6)
		IF (SELECT COUNT(MANV) FROM NHANVIEN) = 0
			SET @ID = '001'
		ELSE
		BEGIN
			SELECT @ID = MAX(RIGHT(MANV, LEN(MANV) - 2)) FROM NHANVIEN;
			SET @ID = @ID + 1
			WHILE LEN(@ID) < 3 
			BEGIN 
				SET @ID = '0' + @ID 
			END
		END
		SET @ID = 'NV' + @ID

		RETURN @ID
	END
GO

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'Insert_New_Candidate')
DROP PROCEDURE dbo.Insert_New_Candidate;
GO
	CREATE PROCEDURE dbo.Insert_New_Candidate
	AS
	BEGIN
		DECLARE @ID VARCHAR(6)
		SELECT @ID = dbo.AUTO_IDNhanVien() 
		INSERT INTO NHANVIEN
		VALUES (@ID,'','','1/1/1996','GT001','','admin1','admin1','MNV002')
	END
GO

------------------Ton Kho---------------------
IF EXISTS(SELECT name FROM sys.objects WHERE name = N'AUTO_IDTonKho')
DROP FUNCTION dbo.AUTO_IDTonKho;
GO
	CREATE FUNCTION dbo.AUTO_IDTonKho()
	RETURNS DATETIME
	AS
	BEGIN
		DECLARE @ID DATETIME
		IF (SELECT MAX(THOIGIAN) FROM TONKHO) = 0
			SET @ID = '2007-04-03 00:00:00.000'
		ELSE
		BEGIN
			SELECT @ID = MAX(THOIGIAN) FROM TONKHO;
			SET @ID = @ID + 1
		END
		RETURN @ID
	END
GO

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'Insert_New_TonKho')
DROP PROCEDURE dbo.Insert_New_TonKho;
GO
	CREATE PROCEDURE dbo.Insert_New_TonKho
	AS
	BEGIN
		DECLARE @ID DATETIME
		SELECT @ID = dbo.AUTO_IDTonKho() 
		INSERT INTO TONKHO
		VALUES (@ID,'HH001','')
	END
GO

------------------Phieu Dat Hang---------------------
IF EXISTS(SELECT name FROM sys.objects WHERE name = N'AUTO_IDPhieuDatHang')
DROP FUNCTION dbo.AUTO_IDPhieuDatHang;
GO
	CREATE FUNCTION dbo.AUTO_IDPhieuDatHang()
	RETURNS VARCHAR(6)
	AS
	BEGIN
		DECLARE @ID VARCHAR(6)
		IF (SELECT COUNT(MAPHIEUDATHANG) FROM PHIEUDATHANG) = 0
			SET @ID = '001'
		ELSE
		BEGIN
			SELECT @ID = MAX(RIGHT(MAPHIEUDATHANG, LEN(MAPHIEUDATHANG) - 3)) FROM PHIEUDATHANG;
			SET @ID = @ID + 1
			WHILE LEN(@ID) < 3 
			BEGIN 
				SET @ID = '0' + @ID 
			END
		END
		SET @ID = 'PDH' + @ID

		RETURN @ID
	END
GO

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'Insert_New_PhieuDatHang')
DROP PROCEDURE dbo.Insert_New_PhieuDatHang;
GO
	CREATE PROCEDURE dbo.Insert_New_PhieuDatHang
	AS
	BEGIN
		DECLARE @ID VARCHAR(6)
		SELECT @ID = dbo.AUTO_IDPhieuDatHang() 

		DECLARE @THISDAY DATETIME
		SELECT @THISDAY = GETDATE()

		INSERT INTO PHIEUDATHANG
		VALUES (@ID,'NCC001','NV001',@THISDAY)
	END
GO


------------------Chi Tiet Phieu Dat Hang---------------------
IF EXISTS(SELECT name FROM sys.objects WHERE name = N'Insert_New_ChiTietPhieuDatHang')
DROP PROCEDURE dbo.Insert_New_ChiTietPhieuDatHang;
GO
	CREATE PROCEDURE dbo.Insert_New_ChiTietPhieuDatHang
	@ID VARCHAR(6)
	AS
	BEGIN
		DECLARE @THISDAY DATETIME
		SELECT @THISDAY = GETDATE()

		IF NOT EXISTS(SELECT * FROM CHITIETPHIEUDATHANG WHERE MAPHIEUDATHANG = @ID AND MAHH = 'HH001')
		BEGIN
			INSERT INTO CHITIETPHIEUDATHANG
			VALUES (@ID,'HH001','0')
		END
	END
GO


------------------Phieu Nhan Hang---------------------
IF EXISTS(SELECT name FROM sys.objects WHERE name = N'AUTO_IDPhieuNhanHang')
DROP FUNCTION dbo.AUTO_IDPhieuNhanHang;
GO
	CREATE FUNCTION dbo.AUTO_IDPhieuNhanHang()
	RETURNS VARCHAR(6)
	AS
	BEGIN
		DECLARE @ID VARCHAR(6)
		IF (SELECT COUNT(MAPHIEU) FROM PHIEUNHANHANG) = 0
			SET @ID = '001'
		ELSE
		BEGIN
			SELECT @ID = MAX(RIGHT(MAPHIEU, LEN(MAPHIEU) - 3)) FROM PHIEUNHANHANG;
			SET @ID = @ID + 1
			WHILE LEN(@ID) < 3 
			BEGIN 
				SET @ID = '0' + @ID 
			END
		END
		SET @ID = 'PNH' + @ID

		RETURN @ID
	END
GO

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'Insert_New_PhieuNhanHang')
DROP PROCEDURE dbo.Insert_New_PhieuNhanHang;
GO
	CREATE PROCEDURE dbo.Insert_New_PhieuNhanHang
	AS
	BEGIN
		DECLARE @ID VARCHAR(6)
		SELECT @ID = dbo.AUTO_IDPhieuNhanHang() 

		DECLARE @THISDAY DATETIME
		SELECT @THISDAY = GETDATE()

		INSERT INTO PHIEUNHANHANG
		VALUES (@ID,'NCC001','NV001',@THISDAY,'0')
	END
GO

------------------Chi Tiet Phieu Nhan Hang---------------------
IF EXISTS(SELECT name FROM sys.objects WHERE name = N'Insert_New_ChiTietPhieuNhanHang')
DROP PROCEDURE dbo.Insert_New_ChiTietPhieuNhanHang;
GO
	CREATE PROCEDURE dbo.Insert_New_ChiTietPhieuNhanHang
	@ID VARCHAR(6)
	AS
	BEGIN
		DECLARE @THISDAY DATETIME
		SELECT @THISDAY = GETDATE()

		IF NOT EXISTS(SELECT * FROM CHITIETPHIEUNHANHANG WHERE MAPHIEU = @ID AND MAHH = 'HH001')
		BEGIN
			INSERT INTO CHITIETPHIEUNHANHANG
				VALUES (@ID,'HH001','0','0','','PDH001')
		END
	END
GO

------------------Phieu Nhan Hang---------------------
IF EXISTS(SELECT name FROM sys.objects WHERE name = N'AUTO_IDPhieuBanHang')
DROP FUNCTION dbo.AUTO_IDPhieuBanHang;
GO
	CREATE FUNCTION dbo.AUTO_IDPhieuBanHang()
	RETURNS VARCHAR(6)
	AS
	BEGIN
		DECLARE @ID VARCHAR(6)
		IF (SELECT COUNT(MAPHIEU) FROM PHIEUBANHANG) = 0
			SET @ID = '001'
		ELSE
		BEGIN
			SELECT @ID = MAX(RIGHT(MAPHIEU, LEN(MAPHIEU) - 3)) FROM PHIEUBANHANG;
			SET @ID = @ID + 1
			WHILE LEN(@ID) < 3 
			BEGIN 
				SET @ID = '0' + @ID 
			END
		END
		SET @ID = 'PBH' + @ID

		RETURN @ID
	END
GO

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'Insert_New_PhieuBanHang')
DROP PROCEDURE dbo.Insert_New_PhieuBanHang;
GO
	CREATE PROCEDURE dbo.Insert_New_PhieuBanHang
	AS
	BEGIN
		DECLARE @ID VARCHAR(6)
		SELECT @ID = dbo.AUTO_IDPhieuBanHang() 

		DECLARE @THISDAY DATETIME
		SELECT @THISDAY = GETDATE()

		INSERT INTO PHIEUBANHANG
		VALUES (@ID,'KH001','NV001',@THISDAY,'0')
	END
GO

------------------Chi Tiet Phieu Nhan Hang---------------------
IF EXISTS(SELECT name FROM sys.objects WHERE name = N'Insert_New_ChiTietPhieuBanHang')
DROP PROCEDURE dbo.Insert_New_ChiTietPhieuBanHang;
GO
	CREATE PROCEDURE dbo.Insert_New_ChiTietPhieuBanHang
	@ID VARCHAR(6)
	AS
	BEGIN
		DECLARE @THISDAY DATETIME
		SELECT @THISDAY = GETDATE()

		IF NOT EXISTS(SELECT * FROM CHITIETPHIEUBANHANG WHERE MAPHIEU = @ID AND MAHH = 'HH001')
		BEGIN
			INSERT INTO CHITIETPHIEUBANHANG
				VALUES (@ID,'HH001','0','0','0')
		END
	END
GO

-----------------------------------------------
--==============NH?P LI?U ====================
-----------------------------------------------

--------------KHÁCH HÀNG-----------------
INSERT INTO KHACHHANG
VALUES('KH001','KHACH HANG MAC DINH','','')

INSERT INTO KHACHHANG
VALUES('KH002','NGUYEN VAN A','THOAI SON','123456')

INSERT INTO KHACHHANG
VALUES('KH003','NGUYEN THI THANH','CHAU DOC','234567')

INSERT INTO KHACHHANG
VALUES('KH004','TRAN NGUYEN ANH THU','CHAU THANH','687456')

INSERT INTO KHACHHANG
VALUES('KH005','LE TRAN NGUYEN','THOAI SON','781236')

INSERT INTO KHACHHANG
VALUES('KH006','BUI DUC THINH','CAO LANH','124756')

-----------------LO?I NHÂN VIÊN----------------
INSERT INTO LOAINHANVIEN
VALUES('MNV001','QUAN LY')

INSERT INTO LOAINHANVIEN
VALUES('MNV002','BAN HANG')

---------------GI?I TÍNH--------------------
INSERT INTO GIOITINH
VALUES('GT001','NAM')

INSERT INTO GIOITINH
VALUES('GT002','NU')

---------------NHÂN VIÊN------------------
INSERT INTO NHANVIEN
VALUES ('NV001','NHAN VIEN MAC DINH','','10/10/1986','GT002','012345','admin1','admin1','MNV001')

INSERT INTO NHANVIEN
VALUES ('NV002','TRAN QUOC TRUNG','TINH BIEN','05/11/1986','GT001','122345','admin2','admin2','MNV001')

INSERT INTO NHANVIEN
VALUES ('NV003','NGUYEN THI HONG VAN','CHAU DOC','12/05/1985','GT002','067954','user1','user1','MNV002')

INSERT INTO NHANVIEN
VALUES ('NV004','CHE THI MAI HIEU','SA DEC','11/01/1987','GT002','123489','user2','user2','MNV002')

INSERT INTO NHANVIEN
VALUES ('NV005','PHAM PHUOC NGUYEN','PHU TAN','02/03/1981','GT001','698745','user3','user3','MNV002')

------------------NHÀ CUNG C?P------------------
INSERT INTO NHACUNGCAP
VALUES ('NCC001','NHA CUNG CAP MAC DINH','','')

INSERT INTO NHACUNGCAP
VALUES ('NCC002','NHA MAY THUOC LA ÐONG THAP','CAO LANH-ÐONG THAP','067987455')

INSERT INTO NHACUNGCAP
VALUES ('NCC003','NHA MAY BAI SAI GON','NGUYEN CHI THANH-TP HCM','08987455')

INSERT INTO NHACUNGCAP
VALUES ('NCC004','CTY DUOC HAU GIANG','CAN THO','071897455')

INSERT INTO NHACUNGCAP
VALUES ('NCC005','CTY BANH KEO BIEN HOA','BIEN HOA','0917987455')

----------------ÐON V? TÍNH---------------------
INSERT INTO DONVITINH
VALUES ('DVT001','KILOGAM')

INSERT INTO DONVITINH
VALUES ('DVT002','GOI')

INSERT INTO DONVITINH
VALUES ('DVT003','KET')

INSERT INTO DONVITINH
VALUES ('DVT004','BICH')

INSERT INTO DONVITINH
VALUES ('DVT005','THUNG')

-----------------HÀNG HÓA----------------------
INSERT INTO HANGHOA
VALUES ('HH001','HANG HOA MAC DINH','DVT003','11/10/2000','0','0','0','0')

INSERT INTO HANGHOA
VALUES ('HH002','BIA SAI GON','DVT003','11/10/2018','200','20','5','5000')

INSERT INTO HANGHOA
VALUES ('HH003','KEO','DVT004','07/06/2017','300','100','10','3000')

INSERT INTO HANGHOA
VALUES ('HH004','ÐUONG','DVT001','10/12/2016','500','50','5','8000')

INSERT INTO HANGHOA
VALUES ('HH005','THUOC LA','DVT002','01/01/2018','200','10','5','8000')

INSERT INTO HANGHOA
VALUES ('HH006','THUOC TAY','DVT005','06/06/2016','100','10','10','6000')

INSERT INTO HANGHOA
VALUES ('HH007','MUOI','DVT002','10/04/2018','400','50','10','2000')

----------PHI?U BÁN HÀNG---------------------
INSERT INTO PHIEUBANHANG
VALUES ('PBH001','KH001','NV002','10/11/2006','')

INSERT INTO PHIEUBANHANG
VALUES ('PBH002','KH004','NV003','08/10/2007','')

INSERT INTO PHIEUBANHANG
VALUES ('PBH003','KH002','NV001','12/04/2007','')

INSERT INTO PHIEUBANHANG
VALUES ('PBH004','KH001','NV004','05/09/2005','')

-----------PHI?U Ð?T HÀNG---------------------
INSERT INTO PHIEUDATHANG
VALUES ('PDH001','NCC001','NV002','10/11/2006')

INSERT INTO PHIEUDATHANG
VALUES ('PDH002','NCC002','NV004','07/10/2007')

INSERT INTO PHIEUDATHANG
VALUES ('PDH003','NCC004','NV001','01/06/2006')

-------------PHI?U NH?N HÀNG------------------
INSERT INTO PHIEUNHANHANG
VALUES ('PNH001','NCC001','NV001','01/06/2007','')

INSERT INTO PHIEUNHANHANG
VALUES ('PNH002','NCC004','NV002','10/10/2006','')

INSERT INTO PHIEUNHANHANG
VALUES ('PNH003','NCC003','NV005','11/12/2006','')

-------------CHI TI?T PHI?U BÁN HÀNG------------
INSERT INTO CHITIETPHIEUBANHANG
VALUES ('PBH001','HH002','3000','100','300000')

INSERT INTO CHITIETPHIEUBANHANG
VALUES ('PBH002','HH001','5000','1000','5000000')

INSERT INTO CHITIETPHIEUBANHANG
VALUES ('PBH003','HH004','8000','200','1600000')

INSERT INTO CHITIETPHIEUBANHANG
VALUES ('PBH004','HH005','6000','500','3000000')


-------------CHI TI?T PHI?U Ð?T HÀNG------------
INSERT INTO CHITIETPHIEUDATHANG
VALUES ('PDH001','HH002','300')

INSERT INTO CHITIETPHIEUDATHANG
VALUES ('PDH002','HH003','1000')

INSERT INTO CHITIETPHIEUDATHANG
VALUES ('PDH003','HH005','500')


------------CHI TI?T PHI?U NH?N HÀNG-----------
INSERT INTO CHITIETPHIEUNHANHANG
VALUES ('PNH001','HH004','5000','500','','PDH003')

INSERT INTO CHITIETPHIEUNHANHANG
VALUES ('PNH002','HH001','10000','200','','PDH004')

INSERT INTO CHITIETPHIEUNHANHANG
VALUES ('PNH003','HH002','15000','200','','PDH001')

--------------PHI?U S? C?------------------
INSERT INTO PHIEUSUCO
VALUES ('PSC001','HH001','10/12/2005','','50','10000','')

INSERT INTO PHIEUSUCO
VALUES ('PSC002','HH002','01/01/2006','','100','15000','')



---------------T?N KHO------------------

INSERT INTO TONKHO
VALUES ('04/06/2007','HH001','100')


INSERT INTO TONKHO
VALUES ('04/05/2007','HH002','90')

INSERT INTO TONKHO
VALUES ('04/04/2007','HH003','50')

INSERT INTO TONKHO
VALUES ('04/03/2007','HH004','70')



--1------------------------------------------------------------------
IF EXISTS(SELECT name FROM sys.objects WHERE name = N'crt_vw_thongke_tonkho')
DROP PROCEDURE dbo.crt_vw_thongke_tonkho;
GO
create procedure crt_vw_thongke_tonkho
AS
GO
	IF EXISTS(SELECT name FROM sys.objects WHERE name = N'vw_tonkho')
	DROP view dbo.vw_tonkho
	GO
	create view dbo.vw_tonkho 
	as
	SELECT "TONKHO"."THOIGIAN", "TONKHO"."MAHH", "TONKHO"."SLTON", "HANGHOA"."TENHH" FROM   "QLCHmoi"."dbo"."TONKHO" "TONKHO" INNER JOIN "QLCHmoi"."dbo"."HANGHOA" "HANGHOA" ON "TONKHO"."MAHH"="HANGHOA"."MAHH"
	GO
GO
GO
--2-----------------------------------------------------------------
IF EXISTS(SELECT name FROM sys.objects WHERE name = N'crt_vw_thongke_hanghoatheodvt')
DROP PROCEDURE dbo.crt_vw_thongke_hanghoatheodvt;
GO
create procedure crt_vw_thongke_hanghoatheodvt
AS
GO
	IF EXISTS(SELECT name FROM sys.objects WHERE name = N'vw_hanghoa')
	DROP view dbo.vw_hanghoa
	GO
	create view dbo.vw_hanghoa
	as
 SELECT "HANGHOA"."MAHH", "HANGHOA"."TENHH", "HANGHOA"."MADVT", "HANGHOA"."NGAYHETHAN", "HANGHOA"."SOLUONG", "HANGHOA"."DONGIA", "DONVITINH"."TENDVT"
 FROM   "QLCHmoi"."dbo"."HANGHOA" "HANGHOA" INNER JOIN "QLCHmoi"."dbo"."DONVITINH" "DONVITINH" ON "HANGHOA"."MADVT"="DONVITINH"."MADVT"
	GO
GO
GO

--3------------------------------------------------------------------

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'vw_donvitinh')
	DROP view dbo.vw_donvitinh
	GO
	create view dbo.vw_donvitinh
	as
 SELECT "DONVITINH"."MADVT", "DONVITINH"."TENDVT"
 FROM   "QLCHmoi"."dbo"."DONVITINH" "DONVITINH"
go
---4-------------------------------------------------------------------

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'vw_khachhang')
	DROP view dbo.vw_khachhang
	GO
	create view dbo.vw_khachhang
	as
    SELECT "KHACHHANG"."MAKH", "KHACHHANG"."HOTEN", "KHACHHANG"."DIACHI", "KHACHHANG"."DIENTHOAI"
    FROM   "QLCHmoi"."dbo"."KHACHHANG" "KHACHHANG"
go
---5------------------------------------------------------------------

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'vw_nhacungcap')
	DROP view dbo.vw_nhacungcap
	GO
	create view dbo.vw_nhacungcap
	as
	SELECT "NHACUNGCAP"."MANCC", "NHACUNGCAP"."TENNCC", "NHACUNGCAP"."DIACHI", "NHACUNGCAP"."DIENTHOAI"
	FROM   "QLCHmoi"."dbo"."NHACUNGCAP" "NHACUNGCAP"
go
----6----------------------------------------------------------------

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'vw_nhanvien')
	DROP view dbo.vw_nhanvien
	GO
	create view dbo.vw_nhanvien
	as
	SELECT "NHANVIEN"."MANV", "NHANVIEN"."HOTEN", "NHANVIEN"."DIACHI", "NHANVIEN"."NGAYSINH", "NHANVIEN"."GIOITINH", "NHANVIEN"."DIENTHOAI", "NHANVIEN"."MALOAINV"
	FROM   "QLCHmoi"."dbo"."NHANVIEN" "NHANVIEN"
go
-----7---------------------------------------------------------------

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'vw_phieubanhang')
	DROP view dbo.vw_phieubanhang
	GO
	create view dbo.vw_phieubanhang
	as
	SELECT "PHIEUBANHANG"."MAPHIEU", "CHITIETPHIEUBANHANG"."MAHH", "CHITIETPHIEUBANHANG"."THANHTIEN", "NHANVIEN"."HOTEN" as HOTENNV, "NHANVIEN"."MALOAINV", "KHACHHANG"."HOTEN", "KHACHHANG"."MAKH"
	FROM   (("QLCHmoi"."dbo"."CHITIETPHIEUBANHANG" "CHITIETPHIEUBANHANG" 
	INNER JOIN "QLCHmoi"."dbo"."PHIEUBANHANG" "PHIEUBANHANG" ON "CHITIETPHIEUBANHANG"."MAPHIEU"="PHIEUBANHANG"."MAPHIEU") 
	INNER JOIN "QLCHmoi"."dbo"."KHACHHANG" "KHACHHANG" ON "PHIEUBANHANG"."MAKH"="KHACHHANG"."MAKH") 
	INNER JOIN "QLCHmoi"."dbo"."NHANVIEN" "NHANVIEN" ON "PHIEUBANHANG"."MANV"="NHANVIEN"."MANV"
go
------8--------------------------------------------------------------

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'vw_phieudathang')
	DROP view dbo.vw_phieudathang
	GO
	create view dbo.vw_phieudathang
	as
	SELECT "PHIEUDATHANG"."MAPHIEUDATHANG", "CHITIETPHIEUDATHANG"."MAHH", "CHITIETPHIEUDATHANG"."SOLUONG", "NHANVIEN"."HOTEN", "NHANVIEN"."MALOAINV", "NHACUNGCAP"."TENNCC", "PHIEUDATHANG"."MANCC"
	FROM   (("QLCHmoi"."dbo"."CHITIETPHIEUDATHANG" "CHITIETPHIEUDATHANG" 
	INNER JOIN "QLCHmoi"."dbo"."PHIEUDATHANG" "PHIEUDATHANG" ON "CHITIETPHIEUDATHANG"."MAPHIEUDATHANG"="PHIEUDATHANG"."MAPHIEUDATHANG") 
	INNER JOIN "QLCHmoi"."dbo"."NHACUNGCAP" "NHACUNGCAP" ON "PHIEUDATHANG"."MANCC"="NHACUNGCAP"."MANCC") 
	INNER JOIN "QLCHmoi"."dbo"."NHANVIEN" "NHANVIEN" ON "PHIEUDATHANG"."MANV"="NHANVIEN"."MANV"
go
-------9-------------------------------------------------------------

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'vw_phieunhanhang')
	DROP view dbo.vw_phieunhanhang
	GO
	create view dbo.vw_phieunhanhang
	as
	SELECT "CHITIETPHIEUNHANHANG"."MAPHIEU", "CHITIETPHIEUNHANHANG"."MAPHIEUDATHANG", "NHACUNGCAP"."TENNCC", "NHANVIEN"."HOTEN"
	FROM   (("QLCHmoi"."dbo"."CHITIETPHIEUNHANHANG" "CHITIETPHIEUNHANHANG" 
	INNER JOIN "QLCHmoi"."dbo"."PHIEUNHANHANG" "PHIEUNHANHANG" ON "CHITIETPHIEUNHANHANG"."MAPHIEU"="PHIEUNHANHANG"."MAPHIEU") 
	INNER JOIN "QLCHmoi"."dbo"."NHACUNGCAP" "NHACUNGCAP" ON "PHIEUNHANHANG"."MANCC"="NHACUNGCAP"."MANCC") 
	INNER JOIN "QLCHmoi"."dbo"."NHANVIEN" "NHANVIEN" ON "PHIEUNHANHANG"."MANV"="NHANVIEN"."MANV"
go
--------10-------------------------------------------------------------

IF EXISTS(SELECT name FROM sys.objects WHERE name = N'vw_phieusuco')
	DROP view dbo.vw_phieusuco
	GO
	create view dbo.vw_phieusuco
	as
	SELECT "PHIEUSUCO"."MAPHIEUSUCO", "PHIEUSUCO"."NGAYHUHONG", "PHIEUSUCO"."SOLUONGHUHONG", "PHIEUSUCO"."DONGIA", "PHIEUSUCO"."TONGTIENHUHONG", "HANGHOA"."TENHH"
	FROM   "QLCHmoi"."dbo"."PHIEUSUCO" "PHIEUSUCO" 
	INNER JOIN "QLCHmoi"."dbo"."HANGHOA" "HANGHOA" ON "PHIEUSUCO"."MAHH"="HANGHOA"."MAHH"
go


















 




